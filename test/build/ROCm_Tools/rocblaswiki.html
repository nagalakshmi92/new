

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rocblas build wiki &mdash; ReadTheDocs-Breathe 1.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> ReadTheDocs-Breathe
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../ROCm.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Current_Release_Notes/Current-Release-Notes.html">Current Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Installation_Guide/Installation-Guide.html">ROCm Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Programming_Guides/Programming-Guides.html">Programming Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ROCm_GPU_Tunning_Guides/ROCm-GPU-Tunning-Guides.html">ROCm GPU Tuning Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GCN_ISA_Manuals/GCN-ISA-Manuals.html">GCN ISA Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ROCm_API_References/ROCm-API-References.html">ROCm API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="ROCm-Tools.html">ROCm Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ROCm_Libraries/ROCm_Libraries.html">ROCm Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ROCm_Compiler_SDK/ROCm-Compiler-SDK.html">ROCm Compiler SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ROCm_System_Managment/ROCm-System-Managment.html">ROCm System Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ROCm_Virtualization_Containers/ROCm-Virtualization-&amp;-Containers.html">ROCm Virtualization &amp; Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Remote_Device_Programming/Remote-Device-Programming.html">Remote Device Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Deep_learning/Deep-learning.html">Deep Learning on ROCm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Other_Solutions/Other-Solutions.html">System Level Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorial/Tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ROCm_Glossary/ROCm-Glossary.html">ROCm Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ReadTheDocs-Breathe</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>rocblas build wiki</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/ROCm_Tools/rocblaswiki.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rocblas-build-wiki">
<span id="rocblaswiki"></span><h1>rocblas build wiki<a class="headerlink" href="#rocblas-build-wiki" title="Permalink to this headline">¶</a></h1>
<div class="section" id="home">
<h2>Home<a class="headerlink" href="#home" title="Permalink to this headline">¶</a></h2>
<div class="section" id="building-rocblas">
<h3>Building rocBLAS<a class="headerlink" href="#building-rocblas" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ol class="arabic simple">
<li>For instructions to build rocblas library and clients, see Build rocBLAS libraries and verification code.</li>
<li>For an example using rocBLAS see Example C code calling rocBLAS function.</li>
<li>For instructions on how to run/use the client code, see Build rocBLAS libraries, verification-code, tests and benchmarks.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="functionality">
<h3>Functionality<a class="headerlink" href="#functionality" title="Permalink to this headline">¶</a></h3>
<p>rocBLAS exports the following BLAS-like functions at this time.</p>
</div>
<div class="section" id="rules-for-obtaining-the-rocblas-api-from-legacy-blas">
<h3>Rules for obtaining the rocBLAS API from Legacy BLAS<a class="headerlink" href="#rules-for-obtaining-the-rocblas-api-from-legacy-blas" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ol class="arabic simple">
<li>The Legacy BLAS routine name is changed to lower case, and prefixed by <a href="#id3"><span class="problematic" id="id4">rocblas_</span></a>.</li>
<li>A first argument rocblas_handle handle is added to all rocBlas functions.</li>
<li>Input arguments are declared with the const modifier.</li>
<li>Character arguments are replaced with enumerated types defined in rocblas_types.h. They are passed by value on the host.</li>
<li>Array arguments are passed by reference on the device.</li>
<li>Scalar arguments are passed by value on the host with the following two exceptions:</li>
</ol>
<ul class="simple">
<li>Scalar values alpha and beta are passed by reference on either the host or the device. The rocBLAS functions will check to see it    the value is on the device. If this is true, it is used, else the value on the host is used.</li>
<li>Where Legacy BLAS functions have return values, the return value is instead added as the last function argument. It is returned by   reference on either the host or the device. The rocBLAS functions will check to see it the value is on the device. If this is true,     it is used, else the value is returned on the host. This applies to the following functions: xDOT, xDOTU, xNRM2, xASUM, IxAMAX,         IxAMIN.</li>
</ul>
<ol class="arabic simple" start="7">
<li>The return value of all functions is rocblas_status, defined in rocblas_types.h. It is used to check for errors.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="additional-notes">
<h3>Additional notes<a class="headerlink" href="#additional-notes" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>The rocBLAS library is LP64, so rocblas_int arguments are 32 bit and rocblas_long arguments are 64 bit.</li>
<li>rocBLAS uses column-major storage for 2D arrays, and 1 based indexing for the functions xMAX and xMIN. This is the same as Legacy    BLAS and cuBLAS. If you need row-major and 0 based indexing (used in C language arrays) download the <a class="reference external" href="http://www.netlib.org/blas/#_cblas">CBLAS</a> file cblas.tgz. Look at       the CBLAS functions that provide a thin interface to Legacy BLAS. They convert from    row-major, 0 based, to column-major, 1 based.
This is done by swapping the order of function arguments. It is not necessary to transpose matrices.</li>
<li>The auxiliary functions rocblas_set_pointer and rocblas_get_pointer are used to set and get the value of the state variable          rocblas_pointer_mode. This variable is not used, it is added for compatibility with cuBLAS. rocBLAS will check if your scalar           argument passed by reference is on the device. If this is true it will pass by reference on the device, else it passes by               reference on the host.</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="build">
<h2>Build<a class="headerlink" href="#build" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dependencies-for-building-library">
<h3>Dependencies For Building Library<a class="headerlink" href="#dependencies-for-building-library" title="Permalink to this headline">¶</a></h3>
<p><strong>CMake 3.5 or later</strong></p>
<p>The build infrastructure for rocBLAS is based on <a class="reference external" href="https://cmake.org/">Cmake</a> v3.5. This is the version of cmake available on ROCm supported platforms. If you are on a headless machine without the x-windows system, we recommend using <strong>ccmake</strong>; if you have access to X-windows, we recommend using <strong>cmake-gui</strong>.</p>
<p>Install one-liners cmake:</p>
<blockquote>
<div><ul class="simple">
<li>Ubuntu: sudo apt install cmake-qt-gui</li>
<li>Fedora: sudo dnf install cmake-gui</li>
</ul>
</div></blockquote>
<p><strong>Python 2.7</strong></p>
<p>By default both python2 and python3 are on Ubuntu. You can check the installation with python -V. Python is used in Tensile, and Tensile is part of rocBLAS. To build rocBLAS the default version of Python must be Python 2.7, not Python 3.</p>
</div>
<div class="section" id="build-library-using-script-ubuntu-only">
<h3>Build Library Using Script (Ubuntu only)<a class="headerlink" href="#build-library-using-script-ubuntu-only" title="Permalink to this headline">¶</a></h3>
<p>The root of this repository has a helper bash script install.sh to build and install rocBLAS on Ubuntu with a single command. It does not take a lot of options and hard-codes configuration that can be specified through invoking cmake directly, but it’s a great way to get started quickly and can serve as an example of how to build/install. A few commands in the script need sudo access, so it may prompt you for a password.</p>
<blockquote>
<div><ul class="simple">
<li>./install.sh -h – shows help</li>
<li>./install.sh -id – build library, build dependencies and install (-d flag only needs to be passed once on a system)</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="build-library-using-individual-commands">
<h3>Build Library Using Individual Commands<a class="headerlink" href="#build-library-using-individual-commands" title="Permalink to this headline">¶</a></h3>
<p>The rocBLAS library has one dependency named <a class="reference external" href="https://github.com/ROCmSoftwarePlatform/Tensile">Tensile</a>, which supplies the high-performance implementation of xGEMM. Tensile is downloaded by cmake during library configuration and automatically configured as part of the build, so no further action is required by the user to set it up. Tensile is predominately written in python2.7 (not python3), so it does bring python dependencies which can easily be installed with distro package managers. The rocBLAS library contains both host and device code, so the HCC compiler must be specified during cmake configuration to properly initialize build tools. Example steps to build rocBLAS:</p>
<p><strong>(One time only)</strong></p>
<blockquote>
<div><ul class="simple">
<li>Ubuntu: sudo apt install python2.7 python-yaml</li>
<li>Fedora: sudo dnf install python PyYAML</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="configure-and-build-steps">
<h3>Configure and build steps<a class="headerlink" href="#configure-and-build-steps" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mkdir -p [ROCBLAS_BUILD_DIR]/release
cd [ROCBLAS_BUILD_DIR]/release
# Default install location is in /opt/rocm, define -DCMAKE_INSTALL_PREFIX=&lt;path&gt; to specify other
# Default build config is &#39;Release&#39;, define -DCMAKE_BUILD_TYPE=&lt;config&gt; to specify other
CXX=/opt/rocm/bin/hcc ccmake [ROCBLAS_SOURCE]
make -j$(nproc)
sudo make install # sudo required if installing into system directory such as /opt/rocm
</pre></div>
</div>
</div>
<div class="section" id="build-library-tests-benchmarks-samples-using-individual-commands">
<h3>Build Library + Tests + Benchmarks + Samples Using Individual Commands<a class="headerlink" href="#build-library-tests-benchmarks-samples-using-individual-commands" title="Permalink to this headline">¶</a></h3>
<p>The repository contains source for clients that serve as samples, tests and benchmarks. Clients source can be found in the clients subdir.</p>
<p><strong>Dependencies (only necessary for rocBLAS clients)</strong></p>
<p>The rocBLAS samples have no external dependencies, but our unit test and benchmarking applications do. These clients introduce the following dependencies:</p>
<blockquote>
<div><ol class="arabic simple">
<li><a class="reference external" href="http://www.boost.org/">boost</a></li>
<li><dl class="first docutils">
<dt><a class="reference external" href="https://github.com/Reference-LAPACK/lapack-release">lapack</a></dt>
<dd><ul class="first last">
<li>lapack itself brings a dependency on a fortran compiler</li>
</ul>
</dd>
</dl>
</li>
<li><a class="reference external" href="https://github.com/google/googletest">googletest</a></li>
</ol>
</div></blockquote>
<p>Linux distros typically have an easy installation mechanism for boost through the native package manager.</p>
<blockquote>
<div><ul class="simple">
<li>Ubuntu: sudo apt install libboost-program-options-dev</li>
<li>Fedora: sudo dnf install boost-program-options</li>
</ul>
</div></blockquote>
<p>Unfortunately, googletest and lapack are not as easy to install. Many distros do not provide a googletest package with pre-compiled libraries, and the lapack packages do not have the necessary cmake config files for cmake to configure linking the cblas library. rocBLAS provide a cmake script that builds the above dependencies from source. This is an optional step; users can provide their own builds of these dependencies and help cmake find them by setting the CMAKE_PREFIX_PATH definition. The following is a sequence of steps to build dependencies and install them to the cmake default /usr/local.</p>
<p><strong>(optional, one time only)</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mkdir -p [ROCBLAS_BUILD_DIR]/release/deps
cd [ROCBLAS_BUILD_DIR]/release/deps
ccmake -DBUILD_BOOST=OFF [ROCBLAS_SOURCE]/deps   # assuming boost is installed through package manager as above
make -j$(nproc) install
</pre></div>
</div>
<p>Once dependencies are available on the system, it is possible to configure the clients to build. This requires a few extra cmake    flags to the library cmake configure script. If the dependencies are not installed into system defaults (like /usr/local ), you should pass the CMAKE_PREFIX_PATH to cmake to help find them.</p>
<blockquote>
<div><ul class="simple">
<li>-DCMAKE_PREFIX_PATH=”&lt;semicolon separated paths&gt;”</li>
</ul>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Default install location is in /opt/rocm, use -DCMAKE_INSTALL_PREFIX=&lt;path&gt; to specify other
CXX=/opt/rocm/bin/hcc ccmake -DBUILD_CLIENTS_TESTS=ON -DBUILD_CLIENTS_BENCHMARKS=ON [ROCBLAS_SOURCE]
make -j$(nproc)
sudo make install   # sudo required if installing into system directory such as /opt/rocm
CUDA build errata
</pre></div>
</div>
<p>rocBLAS is written with HiP kernels, so it should build and run on CUDA platforms. However, currently the cmake infrastructure is broken with a CUDA backend. However, a BLAS marshalling library that presents a common interface for both ROCm and CUDA backends can be found with <span class="xref std std-ref">hipBLAS</span> .</p>
</div>
<div class="section" id="common-build-problems">
<h3>Common build problems<a class="headerlink" href="#common-build-problems" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>Issue: “Tensile could not be found because dependency Python Interp could not be found”.</li>
<li>Solution: Due to a bug in Tensile, you may need cmake-gui 3.5 and above, though in the cmakefiles it requires 2.8.</li>
<li>Issue: HIP (/opt/rocm/hip) was built using hcc 1.0.xxx-xxx-xxx-xxx, but you are using /opt/rocm/hcc/hcc with version 1.0.yyy-yyy-      yyy-yyy from hipcc. (version does not match) . Please rebuild HIP including cmake or update HCC_HOME variable.</li>
<li>Solution: Download HIP from github and use hcc to build from source and then use the build HIP instead of /opt/rocm/hip one or       singly overwrite the new build HIP to this location.</li>
<li>Issue: For Carrizo - HCC RUNTIME ERROR: Fail to find compatible kernel</li>
<li>Solution: Add the following to the cmake command when configuring: -DCMAKE_CXX_FLAGS=”–amdgpu-target=gfx801”</li>
<li>Issue: For MI25 (Vega10 Server) - HCC RUNTIME ERROR: Fail to find compatible kernel</li>
<li>Solution: export HCC_AMDGPU_TARGET=gfx900</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="device-and-stream-management-in-rocblas">
<h2>Device and Stream management in rocBLAS<a class="headerlink" href="#device-and-stream-management-in-rocblas" title="Permalink to this headline">¶</a></h2>
<div class="section" id="hip-device-management">
<h3>HIP Device management<a class="headerlink" href="#hip-device-management" title="Permalink to this headline">¶</a></h3>
<p>hipSetDevice() &amp; hipGetDevice() are HIP device management APIs. They are NOT part of the rocBLAS API.</p>
<p>Before a HIP kernel invocation, users need to call hipSetDevice() to set a device, e.g. device 1. If users do not explicitly call it, the system by default sets it as device 0. Unless users explicitly call hipSetDevice() to set to another device, their HIP kernels are always launched on device 0.</p>
<p>The above is a HIP (and CUDA) device management approach and has nothing to do with rocBLAS. rocBLAS honors the approach above and assumes users have already set the device before a rocBLAS routine call.</p>
<p>Once users set the device, they create a handle with rocblas_status rocblas_create_handle(rocblas_handle <a href="#id1"><span class="problematic" id="id2">*</span></a>handle)</p>
<p>Subsequent rocBLAS routines take this handle as an input parameter. rocBLAS ONLY queries (by hipGetDevice) the user’s device; rocBLAS but does NOT set the device for users. If rocBLAS does not see a valid device, it returns an error message to users. It is the users’ responsibility to provide a valid device to rocBLAS and ensure the device safety as explained soon.</p>
<p>Users CANNOT switch devices between rocblas_create_handle() and rocblas_destroy_handle() (the same as cuBLAS requires). If users want to change device, they must destroy the current handle, and create another rocBLAS handle (context).</p>
</div>
<div class="section" id="stream-management">
<h3>Stream management<a class="headerlink" href="#stream-management" title="Permalink to this headline">¶</a></h3>
<p>HIP kernels are always launched in a queue (otherwise known as a stream, they are the same thing).</p>
<p>If users do not explicitly specify a stream, the system provides a default stream, maintained by the system. Users cannot create or destroy the default stream. Howevers, users can freely create new streams (with hipStreamCreate) and bind it to the rocBLAS handle: rocblas_set_stream(rocblas_handle handle, hipStream_t stream_id) HIP kernels are invoked in rocBLAS routines. The rocBLAS handles are always associated with a stream, and rocBLAS passes its stream to the kernels inside the routine. One rocBLAS routine only takes one stream in a single invocation. If users create a stream, they are responsible for destroying it.</p>
</div>
<div class="section" id="multiple-streams-and-multiple-devices">
<h3>Multiple streams and multiple devices<a class="headerlink" href="#multiple-streams-and-multiple-devices" title="Permalink to this headline">¶</a></h3>
<p>If the system under test has 4 HIP devices, users can run 4 rocBLAS handles (also known as contexts) on 4 devices concurrently, but can NOT span a single rocBLAS handle on 4 discrete devices. Each handle is associated with a particular singular device, and a new handle should be created for each additional device.</p>
</div>
</div>
<div class="section" id="example-c-code-calling-rocblas-routine">
<h2>Example C code calling rocBLAS routine<a class="headerlink" href="#example-c-code-calling-rocblas-routine" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdlib.h&gt;</span>
<span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;vector&gt;</span>
<span class="c1">#include &lt;math.h&gt;</span>
<span class="c1">#include &quot;rocblas.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">rocblas_int</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">10240</span><span class="p">;</span>
    <span class="nb">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">;</span>

    <span class="n">vector</span><span class="o">&lt;</span><span class="nb">float</span><span class="o">&gt;</span> <span class="n">hx</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="nb">float</span><span class="o">&gt;</span> <span class="n">hz</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
    <span class="nb">float</span><span class="o">*</span> <span class="n">dx</span><span class="p">;</span>
    <span class="nb">float</span> <span class="n">tolerance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

    <span class="n">rocblas_handle</span> <span class="n">handle</span><span class="p">;</span>
    <span class="n">rocblas_create_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">allocate</span> <span class="n">memory</span> <span class="n">on</span> <span class="n">device</span>
    <span class="n">hipMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dx</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="nb">float</span><span class="p">));</span>

    <span class="o">//</span> <span class="n">Initial</span> <span class="n">Data</span> <span class="n">on</span> <span class="n">CPU</span><span class="p">,</span>
    <span class="n">srand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span> <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">hx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  <span class="o">//</span><span class="n">generate</span> <span class="n">a</span> <span class="n">integer</span> <span class="n">number</span> <span class="n">between</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">save</span> <span class="n">a</span> <span class="n">copy</span> <span class="ow">in</span> <span class="n">hz</span>
    <span class="n">hz</span> <span class="o">=</span> <span class="n">hx</span><span class="p">;</span>

    <span class="n">hipMemcpy</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">hx</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">sizeof</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="n">hipMemcpyHostToDevice</span><span class="p">);</span>

    <span class="n">rocblas_sscal</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alpha</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">copy</span> <span class="n">output</span> <span class="kn">from</span> <span class="nn">device</span> <span class="n">memory</span> <span class="n">to</span> <span class="n">host</span> <span class="n">memory</span>
    <span class="n">hipMemcpy</span><span class="p">(</span><span class="n">hx</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">dx</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="n">hipMemcpyDeviceToHost</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">verify</span> <span class="n">rocblas_scal</span> <span class="n">result</span>
    <span class="k">for</span><span class="p">(</span><span class="n">rocblas_int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">hz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">hx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;error in element </span><span class="si">%d</span><span class="s2">: CPU=</span><span class="si">%f</span><span class="s2">, GPU=</span><span class="si">%f</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">hx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;SCAL Failed !</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;SCAL Success !</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">hipFree</span><span class="p">(</span><span class="n">dx</span><span class="p">);</span>
    <span class="n">rocblas_destroy_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>================================= Compiler:</p>
<p>The recommend host compiler is [hipcc] (<a class="reference external" href="https://github.com/GPUOpen-ProfessionalCompute-Tools/HIP/">https://github.com/GPUOpen-ProfessionalCompute-Tools/HIP/</a>) (an alias of hcc). Using gcc will lead to compilation error currently. You may need to add /opt/rocm/bin to your path with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export PATH=$PATH:/opt/rocm/bin
</pre></div>
</div>
<p>If the above code is pasted into a file rocblas_sscal_example.cpp the following makefile can be used to build an executable. You will need to give the location of the library with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export LD_LIBRARY_PATH=~/repos/rocBLAS/build/library-package/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}
</pre></div>
</div>
<p>Run the executable with the command</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">rocblas_sscal_example</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Makefile assumes rocBLAS is installed in $(HOME)/repos/rocBLAS/build/library-package
ROCBLAS_INSTALL_DIR=$(HOME)/repos/rocBLAS/build/library-package
ROCBLAS_INCLUDE=$(ROCBLAS_INSTALL_DIR)/include
ROCBLAS_LIB_PATH=$(ROCBLAS_INSTALL_DIR)/lib
ROCBLAS_LIB=rocblas-hcc
HIP_INCLUDE=/opt/rocm/hip/include
LDFLAGS=-lm -L$(ROCBLAS_LIB_PATH) -l$(ROCBLAS_LIB)
LD=hipcc
CFLAGS=-I$(ROCBLAS_INCLUDE) -I$(HIP_INCLUDE)
CPP=hipcc
OBJ=rocblas_sscal_example.o
EXE=rocblas_sscal_example

%.o: %.cpp
        $(CPP) -c -o $@ $&lt; $(CFLAGS)

$(EXE) : $(OBJ)
        $(LD) $(LDFLAGS) $(OBJ) -o $@

clean:
        rm -f $(EXE) $(OBJ)
</pre></div>
</div>
</div>
<div class="section" id="exported-functions">
<h2>Exported functions<a class="headerlink" href="#exported-functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="exported-blas-functions">
<h3>Exported BLAS functions<a class="headerlink" href="#exported-blas-functions" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="rocblas-includes-the-following-auxiliary-functions">
<h3>rocBLAS includes the following auxiliary functions<a class="headerlink" href="#rocblas-includes-the-following-auxiliary-functions" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Function name</td>
</tr>
<tr class="row-even"><td>rocblas_create_handle</td>
</tr>
<tr class="row-odd"><td>rocblas_destroy_handle</td>
</tr>
<tr class="row-even"><td>rocblas_add_stream</td>
</tr>
<tr class="row-odd"><td>rocblas_set_stream</td>
</tr>
<tr class="row-even"><td>rocblas_get_stream</td>
</tr>
<tr class="row-odd"><td>rocblas_set_pointer_mode</td>
</tr>
<tr class="row-even"><td>rocblas_get_pointer_mode</td>
</tr>
<tr class="row-odd"><td>rocblas_set_vector</td>
</tr>
<tr class="row-even"><td>rocblas_get_vector</td>
</tr>
<tr class="row-odd"><td>rocblas_set_matrix</td>
</tr>
<tr class="row-even"><td>rocblas_get_matrix</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="rocblas-includes-the-following-level-1-2-and-3-functions">
<h3>rocBLAS includes the following Level 1, 2, and 3 functions<a class="headerlink" href="#rocblas-includes-the-following-level-1-2-and-3-functions" title="Permalink to this headline">¶</a></h3>
<p><strong>Level 1</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="12%" />
<col width="12%" />
<col width="23%" />
<col width="23%" />
<col width="9%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Function</td>
<td>single</td>
<td>double</td>
<td>single complex</td>
<td>double complex</td>
<td>half</td>
</tr>
<tr class="row-even"><td>rocblas_Xscal</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>rocblas_Xcopy</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>rocblas_Xdot</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>rocblas_Xswap</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>rocblas_Xaxpy</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
</tr>
<tr class="row-odd"><td>rocblas_Xasum</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>rocblas_Xnrm2</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>rocblas_Xamax</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>rocblas_Xamin</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
<p><strong>Level 2</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="12%" />
<col width="12%" />
<col width="23%" />
<col width="23%" />
<col width="9%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Function</td>
<td>single</td>
<td>double</td>
<td>single complex</td>
<td>double complex</td>
<td>half</td>
</tr>
<tr class="row-even"><td>rocblas_Xgemv</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>rocblas_Xger</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
<p><strong>Level 3</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="10%" />
<col width="10%" />
<col width="21%" />
<col width="21%" />
<col width="8%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Function</td>
<td>single</td>
<td>double</td>
<td>single complex</td>
<td>double complex</td>
<td>half</td>
</tr>
<tr class="row-even"><td>rocblas_Xgemm</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>rocblas_Xtrtri</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>rocblas_Xtrtri_batched</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>rocblas_Xtrsm</td>
<td>x</td>
<td>x</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="numerical-stability-in-trsm">
<h2>Numerical Stability in TRSM<a class="headerlink" href="#numerical-stability-in-trsm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="division">
<h3>Division<a class="headerlink" href="#division" title="Permalink to this headline">¶</a></h3>
<p>Most BLAS routines like GEMM, GEMV, GER only perform multiplication and add. As long as there is no overflow (e.g. very big number), the GPU always achieve bit-wise consistence with the CPU results. However, the TRSM and TRTRI routine perform division. Therefore, there are some precision differences between Netlib CBLAS (which we compare to) and rocBLAS.</p>
<p>For example, the gtest may falsely report such failure by using gtest macro ASSERT_FLOAT_EQ in STRSM:</p>
<p>Expected: hCPU[i+j*lda] Which is: -0.66039091</p>
<p>To be equal to: hGPU[i+j*lda] Which is: -0.66039127</p>
<p>However, since we achieve 5 digits consistency (0.66039), we think rocBLAS result is correct. Therefore, we use gtest ASSERT_NEAR in TRSM to replace ASSERT_FLOAT_EQ which is used for other routines.</p>
</div>
<div class="section" id="well-conditioned-matrix">
<h3>Well-conditioned Matrix<a class="headerlink" href="#well-conditioned-matrix" title="Permalink to this headline">¶</a></h3>
<p>Generally, TRTRI and TRSM has matrix inversion involved (accessing half of the matrix). Matrix inversion generally is not numerical stable operation, especially when the matrix is [ill-conditioned] (<a class="reference external" href="https://en.wikipedia.org/wiki/Condition_number">https://en.wikipedia.org/wiki/Condition_number</a>). A random matrix is very ill-conditioned typically. Such matrix will cause serious overflow.</p>
<p>In order to generate a well-conditioned matrix, we perform an LU factorization first on this random matrix. The factorized Lower and upper part overwrite the original matrix. The factorized matrix is a well-conditioned matrix and used as the input matrix in rocBLAS TRSM test.</p>
</div>
</div>
<div class="section" id="profile-rocblas-kernels">
<h2>Profile rocBLAS kernels<a class="headerlink" href="#profile-rocblas-kernels" title="Permalink to this headline">¶</a></h2>
<div class="section" id="by-environment-variable">
<h3>By environment variable<a class="headerlink" href="#by-environment-variable" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>In bash: “export HIP_TRACE_API=1” (reset by =0) Launch your application, then it profiles every HIP APIs, including rocBLAS kernels.</li>
<li>“export HIP_LAUNCH_BLOCKING = 0”: make HIP APIs host-synchronous so they are blocked until any kernel launches or data-copy           commands are complete (an alias is CUDA_LAUNCH_BLOCKING)</li>
<li>For more profiling tools, see Profiling and Debugging HIP Code</li>
</ul>
<p>The IR and ISA can be dumped by setting the following environment variable before building and running the app.</p>
<p>export KMDUMPISA=1</p>
<p>export KMDUMPLLVM=1</p>
<p>export KMDUMPDIR=/path/to/dump</p>
<p>By roprof</p>
<p>a tool very similar to nvprof, roprof is a command line tool to profile HIP kernels, roprof is located in /opt/rocm/profiler/bin</p>
<p>example usage</p>
<p>/opt/rocm/profiler/bin/rcprof -T -a profile.atp ./your_executable</p>
<p>it will dump several a bunch of profile.HSA*.html files, you can view it by any internet browser.</p>
<p>/opt/rocm/profiler/bin/rcprof –help for more options</p>
</div>
</div>
<div class="section" id="running">
<h2>Running<a class="headerlink" href="#running" title="Permalink to this headline">¶</a></h2>
<div class="section" id="notice">
<h3>Notice<a class="headerlink" href="#notice" title="Permalink to this headline">¶</a></h3>
<p>Before reading this Wiki, it is assumed rocBLAS with the client applications has been successfully built as described in Build rocBLAS libraries and verification code</p>
</div>
<div class="section" id="samples">
<h3>Samples<a class="headerlink" href="#samples" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="p">[</span><span class="n">BUILD_DIR</span><span class="p">]</span><span class="o">/</span><span class="n">clients</span><span class="o">/</span><span class="n">staging</span>
<span class="o">./</span><span class="n">example</span><span class="o">-</span><span class="n">sscal</span>
</pre></div>
</div>
<p>Example code that calls rocBLAS you can also see the following blog on the right side Example C code calling rocBLAS routine.</p>
</div>
<div class="section" id="unit-tests">
<h3>Unit tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h3>
<p>Run tests with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="p">[</span><span class="n">BUILD_DIR</span><span class="p">]</span><span class="o">/</span><span class="n">clients</span><span class="o">/</span><span class="n">staging</span>
<span class="o">./</span><span class="n">rocblas</span><span class="o">-</span><span class="n">test</span>
</pre></div>
</div>
<p>To run specific tests, use –gtest_filter=match where match is a ‘:’-separated list of wildcard patterns (called the positive patterns) optionally followed by a ‘-‘ and another ‘:’-separated pattern list (called the negative patterns). For example, run gemv tests with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="p">[</span><span class="n">BUILD_DIR</span><span class="p">]</span><span class="o">/</span><span class="n">clients</span><span class="o">/</span><span class="n">staging</span>
<span class="o">./</span><span class="n">rocblas</span><span class="o">-</span><span class="n">test</span> <span class="o">--</span><span class="n">gtest_filter</span><span class="o">=*</span><span class="n">gemv</span><span class="o">*</span>
</pre></div>
</div>
</div>
<div class="section" id="benchmarks">
<h3>Benchmarks<a class="headerlink" href="#benchmarks" title="Permalink to this headline">¶</a></h3>
<p>Run bencharmks with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="p">[</span><span class="n">BUILD_DIR</span><span class="p">]</span><span class="o">/</span><span class="n">clients</span><span class="o">/</span><span class="n">staging</span>
<span class="o">./</span><span class="n">rocblas</span><span class="o">-</span><span class="n">bench</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
<p>The following are examples for running particular gemm and gemv benchmark:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">rocblas</span><span class="o">-</span><span class="n">bench</span> <span class="o">-</span><span class="n">f</span> <span class="n">gemm</span> <span class="o">-</span><span class="n">r</span> <span class="n">s</span> <span class="o">-</span><span class="n">m</span> <span class="mi">1024</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1024</span> <span class="o">-</span><span class="n">k</span> <span class="mi">1024</span> <span class="o">--</span><span class="n">transposeB</span> <span class="n">T</span>
<span class="o">./</span><span class="n">rocblas</span><span class="o">-</span><span class="n">bench</span> <span class="o">-</span><span class="n">f</span> <span class="n">gemv</span> <span class="o">-</span><span class="n">m</span> <span class="mi">9216</span> <span class="o">-</span><span class="n">n</span> <span class="mi">9216</span> <span class="o">--</span><span class="n">lda</span> <span class="mi">9216</span> <span class="o">--</span><span class="n">transposeA</span> <span class="n">T</span>
</pre></div>
</div>
<p>For users’ convenience, <a class="reference external" href="https://github.com/ROCmSoftwarePlatform/rocBLAS/tree/develop/clients/benchmarks/perf_script">python scripts</a> are provided to perform benchmarking across a range of values.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Thomas Edvalson.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>